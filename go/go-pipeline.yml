resources:
  - name: repo
    type: git
    source:
      uri: https://github.com/thehivecorporation/raccoon.git
      branch: develop

  - name: concourse-generic-scripts
    type: git
    source:
      uri: https://github.com/sayden/concourse-generic-scripts.git
      branch: master
      username: sayden
      password: {{password}}

  - name: concourse-generic-release
    type: github-release
    source:
      repository: https://github.com/sayden/concourse-generic-scripts.git
      user: sayden
      password: {{password}}

jobs:
  - name: unit-tests
    plan:
      - aggregate:
        - get: repo
        - get: concourse-generic-scripts
          trigger: true
      - task: unit-test-task
        file: concourse-generic-scripts/go/unit-test-task.yml

  - name: integration-tests
    plan:
      - aggregate:
        - get: repo
          passed: [unit-tests]
          trigger: true
        - get: concourse-generic-scripts
          trigger: true
      - task: integration-test-task
        file: concourse-generic-scripts/go/integration-test-task.yml

  - name: build-binary
    plan:
      - aggregate:
        - get: repo
          passed: [unit-tests]
          trigger: true
        - get: concourse-generic-scripts
          trigger: true
      - task: build-binary
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: 
              - repository: golang
              - tag: 1.7.1
          inputs:
            - name: repo
              path: gopath/src/github.com/thehivecorporation/raccoon
            - name: concourse-generic-scripts
          run:
            path: sh
            args:
            - -exc
            - |
              export ROOT=$(pwd)
              export GOPATH=$(pwd)/gopath
              cd $GOPATH/src/github.com/thehivecorporation/raccoon
              go build -o $ROOT/releases-examples/raccoon
              cd $ROOT/releases-examples
              tar zcvf raccoon_v0.0.1.tar.gz raccoon
              echo "raccoon" > name
              echo "0.0.1" > tag
              echo "body" > body
          outputs:
            - name: releases-examples

      - put: concourse-generic-release
        params:
          globs: 
          - releases-examples/*.tar.gz
          name: releases-examples/name
          tag: releases-examples/tag
          body: releases-examples/body